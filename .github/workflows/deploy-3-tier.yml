name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - development

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      FRONTEND_IMAGE: dewansh2601/burger-frontend
      BACKEND_IMAGE: dewansh2601/burger-backend
      PROJECT_DIR: ./  # root of your repo
      K8S_NAMESPACE: burger-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      - name: Build Docker images
        run: |
          docker build -t $FRONTEND_IMAGE:$TIMESTAMP $PROJECT_DIR/Frontend
          docker build -t $BACKEND_IMAGE:$TIMESTAMP $PROJECT_DIR/Backend

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker images
        run: |
          docker push $FRONTEND_IMAGE:$TIMESTAMP
          docker push $BACKEND_IMAGE:$TIMESTAMP

      - name: Update image tags in Kubernetes YAMLs
        run: |
          sed -i "s|image: .*/frontend:.*|image: $FRONTEND_IMAGE:$TIMESTAMP|" $PROJECT_DIR/k8s/frontend-deployment-service.yaml
          sed -i "s|image: .*/backend:.*|image: $BACKEND_IMAGE:$TIMESTAMP|" $PROJECT_DIR/k8s/backend-deployment-service.yaml

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Apply Kubernetes manifests to KIND
        run: |
          kubectl apply -f $PROJECT_DIR/k8s/

      - name: Get access info
        run: |
          KIND_HOST=$(hostname -I | awk '{print $1}')
          FRONTEND_PORT=$(kubectl get svc frontend-service -n $K8S_NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
          echo "âœ… App deployed successfully! Open in browser: http://${KIND_HOST}:${FRONTEND_PORT}"
